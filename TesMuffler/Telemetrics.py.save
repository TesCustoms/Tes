#!/usr/bin/env python3
"""
__author__  = "Blaze Sanders"
__email__   = "dev@blazesanders.com"
__status__  = "Development"
__date__    = "Late Updated: 2022-11-02"
__doc__     = "Collect vehicle data to transmit to a central server, hardware switch can turn this off"
"""

# Allow BASH commands to be run inside python code like this file
# https://docs.python.org/3/library/subprocess.html
from subprocess import check_call

try:  # Importing externally developed libraries

    from gpiozero import Button

    import obd

    # Open source plaform for NoSQL databases, authentication, file storage, and auto-generated APIs
    # https://github.com/supabase-community/supabase-py
    from supabase import create_client, Client

    # MySQL for Word Press database connection
    # https://kinsta.com/knowledgebase/wordpress-database
    # https://realpython.com/python-mysql/
    # https://github.com/knadh/simplemysql
    # https://pypi.org/project/mysql-connector-python
    #import simplemysql
    import mysql.connector

except ImportError:  #TODO
    print("The obd module didn't import correctly!")
    executeInstalls = input("Would you like to *** pip3 install obd *** and  *** sudo apt install python3-gpiozero *** (Y/N)? ")
    if(executeInstalls.upper() == "Y" or executeInstalls.upper() == "YES"):
        check_call("pip install obd", shell=True)
        check_call("sudo apt-get install bluetooth bluez", shell=True)
        check_call("sudo apt install python3-gpiozero", shell=True)
        #check_call("pip3 install simplemysql", shell=True) 
        check_call("pip install mysql-connector-python", shell=True)

    else:
        print("You didn't type Y or YES :)")
        print("Follow python-obd manual install instructions at https://python-obd.readthedocs.io/en/latest/#installation")
        print("Follow GPIO Zero manual install instructions at https://gpiozero.readthedocs.io/en/stable/installing.html#")

# Internally developed modules
# Useful global constants for the entire TesCustoms TesMuffler library
import GlobalConstants as GC

# Realtime description of a Car objects state including RPM, gear, make, model, year, and color
from Vehicle import *


class Telemetrics:

    SNAPSHOT_SIZE = 3

    def unitTest():
        """
        ???
        """

        BlazeCar = Vehicle(GC.TESLA, GC.CYBER_TRUCK, 2024, GC.GREY, "12345678901234567")
        TestObject1 = Telemetrics(BlazeCar)
        assert TestObject1.getHardwareSecurityToggleState == GC.DATA_COLLECTION_OFF

        assert TestObject1.collectDataSnapShot == [0x00] * GC.SNAPSHOT_SIZE

        assert TestObject1.sendDataSnapShot == GC.DATABASE_OPERATION_SUCCESFULL


    def getHardwareSecurityToggleState(self):
        """
        https://gpiozero.readthedocs.io/en/stable/recipes.html#button
        """
        toggle = Button(GC.SECURITY_TOOGLE_PIN)    #GC.SECURITY_TOOGLE_PIN = GPIOX  = X in GC

        if toggle.is_pressed:
            state = True
        else:
            state = False

        return state

    def collectDataSnapShot(self):
        """Collect User data if hardware switch GPIO pin is in valid state (not equal to DATA_COLLECTION_OFF)

        Arg(s):
            NONE

        Returns:
           NOTHING
        """

        data = [0x00] * GC.SNAPSHOT_SIZE
        if(Telemetrics.getHardwareSecurityToggleState == GC.DATA_COLLECTION_OFF):
            pass

        else:
            Obd2Object = obd()
            data[0] = Obd2Object.vin()
            data[1] = Obd2Object.odometerReaing()
            data[2] = Obd2Object.currentSpeed()
            #data[3] = Obd2Object.TODO

        return data

    def sendDataSnapShot(self):
        """Pack data into List of size GC.SNAPSHOT_SIZE to send back to database

        Arg(s):
            NONE

        Returns:
            HTTP Status Code of database API call
        """

        data = [0x00] * Telemetrics.SNAPSHOT_SIZE
        if(self.getHardwareSecurityToggleState == GC.DATA_COLLECTION_OFF):
            pass # DO NOTHING WITH USER DATA!
        else:
            data = Telemetrics.collectDataSnapShot()

        response = self.SupabaseObject.insertEntryToTable(self.supabaseObject, GC.USER_TABLE, self.VehicleObject.vin, data)   #TODO why two    self.SupabaseObject?

        return response


    def __init__(self, VehicleObject):
        """Constructor to initialize an Vehicle object

        Defaults to a white 2022 Tesla Model, to make Casey Liss from ATP.fm podcast happy :)

	    Args:
	        VehicleObject (Vehicle.py):  
	        SupabaseObject (supabase): 
        """
        self.VehicleObject = VehicleObject
        self.SupabaseObject = -1 # Client : ????


if __name__ == "__main__":

        Telemetrics.unitTest()
